@* @{
    ViewData["Title"] = "Add Leave Type";
} *@

<h2>@ViewData["Title"]</h2>


@if (TempData["error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@* Display success or error message *@
@if (TempData["success"] != null)
{
    <div class="alert alert-success">
        @TempData["success"]
    </div>
}


@* Form to Add Leave Type *@

@* <div class="col-md-12 text-end">
    <button type="submit" class="btn btn-primary mt-2"><i class="ti ti-circle-plus me-2"></i>Add Leave Type</button>
</div>

<form method="post" asp-action="AddLeaveType">
    <div class="form-group">
        <label for="LeaveType">Leave Type</label>
        <input type="text" class="form-control" id="LeaveType" name="LeaveType" required />
    </div>
</form> *@
<div class="d-md-flex d-block align-items-center justify-content-between page-breadcrumb mb-3">
    <div class="my-auto mb-2">
        <h2 class="mb-1">Leaves</h2>
        <nav>
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item">
                    <a href="index.html"><i class="ti ti-smart-home"></i></a>
                </li>
                <li class="breadcrumb-item">
                    Admin
                </li>
                <li class="breadcrumb-item active" aria-current="page">Add LeaveType</li>
            </ol>
        </nav>
    </div>
    <div class="d-flex my-xl-auto right-content align-items-center flex-wrap ">
        <div class="mb-2">
            <a id="addLeaveButton" data-bs-toggle="modal" data-bs-target="#add_employee" class="btn btn-primary d-flex align-items-center"><i class="ti ti-circle-plus me-2"></i>Add Leave Type</a>

            @*  <button type="button" class="btn btn-primary mt-2" id="addLeaveButton">
                <i class="ti ti-circle-plus me-2"></i>Add Leave Type
            </button> *@
        </div>
        <div class="head-icons ms-2">
            <a href="javascript:void(0);" class="" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-original-title="Collapse" id="collapse-header">
                <i class="ti ti-chevrons-up"></i>
            </a>
        </div>
    </div>
</div>

<!-- Form (Initially Hidden) -->
<form method="post" asp-action="AddLeaveType" id="leaveTypeForm" style="display: none;">
    <div class="form-group">
        <label for="LeaveType">Leave Type</label>
        <input type="text" class="form-control" id="LeaveType" name="LeaveType" required />
    </div>

    <button type="submit" class="btn btn-primary mt-2">Submit</button>
</form>

<hr />

<div class="card">
    <div class="card-header d-flex align-items-center justify-content-between flex-wrap row-gap-3">
        <h5 class="mb-0">LeaveType List</h5>
       @*  <div class="d-flex align-items-center">
            <label class="me-2 mb-0">Sort By:</label>
            <select id="sortBy" class="form-select">
                <option value="ascending">Ascending</option>
                <option value="descending">Descending</option>
                <option value="recent7">Last 7 Days</option>
                <option value="recentlyAdded">Recently Added</option>
                <option value="lastMonth">Last Month</option>
            </select>
        </div> *@
    </div>
    

    <div class="card-body">
        <table class="table" id="leaveTypeTable">
            <thead class="thead-light">
            <tr>
                <th>Leave Type</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
                @if (ViewBag.LeaveTypes != null && ViewBag.LeaveTypes.Count > 0)
                {
                    @foreach (var leave in ViewBag.LeaveTypes)
                    {
                        <tr>
                            <td>@leave.LeaveType</td>
                            <td>
                                @if (leave.Status == "Active")
                                {
                                    <span class="badge badge-success d-inline-flex align-items-center badge-xs">
                                        <i class="ti ti-point-filled me-1"></i>Active
                                    </span>
                                }
                                else if (leave.Status == "Inactive")
                                {
                                    <span class="badge badge-danger d-inline-flex align-items-center badge-xs">
                                        <i class="ti ti-point-filled me-1"></i>Inactive
                                    </span>
                                }
                                else
                                {
                                    <span class="badge badge-secondary d-inline-flex align-items-center badge-xs">
                                        <i class="ti ti-point-filled me-1"></i>@leave.Status
                                    </span>
                                }
                            </td>

                            <td>
                                <form method="post" asp-action="DeleteLeaveType" style="display:inline;" class="delete-form" onsubmit="return confirm('Are you sure you want to delete this leave type?');">
                                    <input type="hidden" name="leaveTypeId" value="@leave.LeaveTypeId" />
                                    <button type="submit" style="background:none;border:none">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                    }
                }
                @* else
                {
                    <tr>
                        <td colspan="3" class="text-center">No leave types found</td>
                    </tr>
                } *@
            </tbody>
        </table>
    </div>
</div>

@section scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css" rel="stylesheet">
    <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
    
    <script>
         $(document).ready(function () {
            $("#addLeaveButton").click(function () {
                $("#leaveTypeForm").toggle(); // Show/hide the form
            });
        });

        $(document).ready(function () {
            var table = $('#leaveTypeTable').DataTable({
                pageLength: 10,
                lengthMenu: [[5, 10, 25, -1], [5, 10, 25, "All"]],
                dom: 'lfrtip',
                language: {
                    search: "Search:",
                    lengthMenu: "Show _MENU_ entries per page",
                    paginate: {
                        first: "First",
                        last: "Last",
                        next: "Next",
                        previous: "Previous"
                    }
                },
                buttons: ['copy', 'excel', 'pdf']
            });

            // Sorting function based on dropdown selection
            $('#sortBy').change(function () {
                var sortBy = $(this).val();
                var columnIndex = 0; // Assuming Leave Type column is used for sorting

                if (sortBy === "ascending") {
                    table.order([columnIndex, 'asc']).draw();
                } else if (sortBy === "descending") {
                    table.order([columnIndex, 'desc']).draw();
                }
            });
        });

              $(document).ready(function () {
            $(".delete-form").submit(function (event) {
                event.preventDefault(); // Prevent default form submission

                var form = $(this);
                var url = form.attr("action");

                $.ajax({
                    type: form.attr("method"),
                    url: url,
                    data: form.serialize(),
                    success: function (response) {
                        location.reload(); // Reload if delete is successful
                    },
                    error: function (xhr) {
                        var response = JSON.parse(xhr.responseText);
                        if (response.isForeignKeyError) {
                            // Show popup for foreign key errors
                            Swal.fire({
                                icon: 'error',
                                title: 'Cannot Delete',
                                text: response.message,
                                confirmButtonColor: '#d33'
                            });
                        } else {
                            // Show normal alert for other errors
                            alert(response.message);
                        }
                    }
                });
            });
        });

           
    </script>
}
