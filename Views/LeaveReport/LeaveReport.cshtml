<!DOCTYPE html>
<html lang="en">

<head>
	@* <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script> *@

</head>

<body>

	@model dynamic
	<!-- Breadcrumb -->
	<div class="d-md-flex d-block align-items-center justify-content-between page-breadcrumb mb-3">
		<div class="my-auto mb-2">
			<h2 class="mb-1">Leave Report</h2>
			<nav>
				<ol class="breadcrumb mb-0">
					<li class="breadcrumb-item">
						<a href="index.html"><i class="ti ti-smart-home"></i></a>
					</li>
					<li class="breadcrumb-item">
						HR
					</li>
					<li class="breadcrumb-item active" aria-current="page">Leave Report</li>
				</ol>
			</nav>
		</div>
		<div class="d-flex my-xl-auto right-content align-items-center flex-wrap ">
			<div class="mb-2">
				<div class="dropdown">
					<a href="javascript:void(0);" class="dropdown-toggle btn btn-white d-inline-flex align-items-center" data-bs-toggle="dropdown">
						<i class="ti ti-file-export me-1"></i>Export
					</a>
					<ul class="dropdown-menu  dropdown-menu-end p-3">
						<li>
							<a asp-controller="LeaveReport" asp-action="ExportToPdf" class="dropdown-item rounded-1"><i class="ti ti-file-type-pdf me-1"></i>Export as PDF</a>
						</li>
						<li>
							<a asp-controller="LeaveReport" asp-action="ExportToExcel" class="dropdown-item rounded-1"><i class="ti ti-file-type-xls me-1"></i>Export as Excel </a>
						</li>
					</ul>
				</div>

			</div>
			<div class="head-icons ms-2">
				<a href="javascript:void(0);" class="" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-original-title="Collapse" id="collapse-header">
					<i class="ti ti-chevrons-up"></i>
				</a>
			</div>
		</div>
	</div>
	<!-- /Breadcrumb -->
	<div class="row">
		<div class="col-xl-6 d-flex">
			<div class="row flex-fill">
				<!-- Total Companies -->
				<div class="col-lg-6 col-md-6 d-flex">
					<div class="card flex-fill">
						<div class="card-body">
							<div class="d-flex align-items-center justify-content-between mb-2 overflow-hidden">
								<div>
									<p class="fs-12 fw-normal mb-1 text-truncate">Total Leaves</p>
									<h4>@ViewBag.TotalLeave</h4>
								</div>
								<div class="leave-report-icon">
									<a href="#"><span class="p-2 border border-primary bg-transparent-primary rounded-circle d-flex align-items-center justify-content-center"><i class="ti ti-calendar-x text-primary"></i></span></a>
								</div>
							</div>
							<div class="p-2 bg-gray-100 br-5">
								<div class="d-flex align-items-center justify-content-between">
									<p class="fs-12 fw-normal mb-0">Last Month</p>
									<span class="fs-12 fw-normal text-success d-flex align-items-center"><i class="ti ti-arrow-wave-right-up text-success me-1"></i>+17.02%</span>
								</div>
							</div>
						</div>
					</div>
				</div>
				<!-- /Total Companies -->
				<!-- Total Companies -->
				<div class="col-lg-6 col-md-6 d-flex">
					<div class="card flex-fill">
						<div class="card-body">
							<div class="d-flex align-items-center justify-content-between mb-2 overflow-hidden">
								<div>
									<p class="fs-12 fw-normal mb-1 text-truncate">Approved Leaves</p>
									<h4>@ViewBag.ApprovedLeave</h4>
								</div>
								<div class="leave-report-icon">
									<a href="#"><span class="p-2 border border-success bg-transparent-success rounded-circle d-flex align-items-center justify-content-center"><i class="ti ti-calendar-x text-success"></i></span></a>
								</div>
							</div>
							<div class="p-2 bg-gray-100 br-5">
								<div class="d-flex align-items-center justify-content-between">
									<p class="fs-12 fw-normal mb-0">Last Month</p>
									<span class="fs-12 fw-normal text-success d-flex align-items-center"><i class="ti ti-arrow-wave-right-up text-success me-1"></i>+17.02%</span>
								</div>
							</div>

						</div>
					</div>
				</div>
				<!-- /Total Companies -->
				<!-- Inactive Companies -->
				<div class="col-lg-6 col-md-6 d-flex">
					<div class="card flex-fill">
						<div class="card-body">
							<div class="d-flex align-items-center justify-content-between mb-2 overflow-hidden">
								<div>
									<p class="fs-12 fw-normal mb-1 text-truncate">Pending Requests</p>
									<h4>@ViewBag.PendingLeave</h4>
								</div>
								<div class="leave-report-icon">
									<a href="#"><span class="p-2 border border-skyblue bg-transparent-skyblue rounded-circle d-flex align-items-center justify-content-center"><i class="ti ti-calendar-x text-skyblue"></i></span></a>
								</div>
							</div>
							<div class="p-2 bg-gray-100 br-5">
								<div class="d-flex align-items-center justify-content-between">
									<p class="fs-12 fw-normal mb-0">Last Month</p>
									<span class="fs-12 fw-normal text-success d-flex align-items-center"><i class="ti ti-arrow-wave-right-up text-success me-1"></i>+17.02%</span>
								</div>
							</div>

						</div>
					</div>
				</div>
				<!-- /Inactive Companies -->
				<!-- Company Location -->
				<div class="col-lg-6 col-md-6 d-flex">
					<div class="card flex-fill">
						<div class="card-body">
							<div class="d-flex align-items-center justify-content-between mb-2 overflow-hidden">
								<div>
									<p class="fs-12 fw-normal mb-1 text-truncate">Rejected Leaves</p>
									<h4>@ViewBag.RejectedLeave</h4>
								</div>
								<div class="leave-report-icon">
									<a href="#"><span class="p-2 border border-danger bg-transparent-danger rounded-circle d-flex align-items-center justify-content-center"><i class="ti ti-calendar-x text-danger"></i></span></a>
								</div>
							</div>
							<div class="p-2 bg-gray-100 br-5">
								<div class="d-flex align-items-center justify-content-between">
									<p class="fs-12 fw-normal mb-0">Last Month</p>
									<span class="fs-12 fw-normal text-success d-flex align-items-center"><i class="ti ti-arrow-wave-right-up text-success me-1"></i>+17.02%</span>
								</div>
							</div>

						</div>
					</div>
				</div>
				<!-- /Company Location -->
			</div>
		</div>
		<div class="col-xl-6 d-flex">
			<div class="card flex-fill">
				<div class="card-header border-0 pb-0">
					<div class="d-flex flex-wrap justify-content-between align-items-center row-gap-2">
						<div class="d-flex align-items-center ">
							<span class="me-2"><i class="ti ti-chart-bar text-danger"></i></span>
							<h5>Leaves </h5>
						</div>

					</div>
				</div>
				<div class="card-body py-0">
					<div>
						<canvas id="leaveChart" width="200" height="200"></canvas>
					</div>

				</div>
			</div>
		</div>
	</div>
	<div class="card">
		<div class="row mb-3">
			<div class="col-md-4">
				<!-- Date Filter Dropdown -->
				<label for="dateFilter">Select Date Filter:</label>
				<select id="dateFilter" class="form-control">
					<option>--Select Date Filter--</option>
					<option value="yesterday">Yesterday</option>
					<option value="last7days">Last 7 Days</option>
					<option value="last30days">Last 30 Days</option>
					<option value="lastYear">Last Year</option>
					<option value="thisYear">This Year</option>
					<option value="customRange">Custom Range</option>
				</select>
			</div>

			<div class="col-md-4">
				<!-- Status Filter Dropdown -->
				<label for="statusFilter">Select Status Filter:</label>
				<select id="statusFilter" class="form-control">
					<option>--Select Status--</option>
					<option value="pending">Pending</option>
					<option value="approved">Approved</option>
					<option value="rejected">Rejected</option>
				</select>
			</div>

			<div class="col-md-4">
				<!-- Sorting Filter Dropdown -->
				<label for="sortOrder">Sort By:</label>
				<select id="sortOrder" class="form-control">
					<option>--Select--</option>
					<option value="asc">Ascending</option>
					<option value="desc">Descending</option>
					<option value="last7days">Last 7 Days</option>
					<option value="lastMonth">Last Month</option>
				</select>
			</div>

		</div>
	</div>
	<div>


		<div class="card-body p-0">

			<div class="custom-datatable-filter table-responsive">
				<table class="table" id="LeaveTable">
					<thead class="thead-light">
						<tr>


							<th>ID</th>
							<th>UserName</th>
							<th>Leave Type</th>
							<th>Start Date</th>
							<th>End Date</th>
							<th>Days</th>
							<th>Reason</th>
							<th>Approved By</th>
							<th>Status</th>
							<th>StatusHistory</th>
						</tr>
					</thead>
					<tbody id="Leave">
						@foreach (var item in Model)
						{
							<tr>
								<td>@item.LeaveRequestId</td>
								<td>
									<div class="d-flex align-items-center">
										<img src="/@item.ProfilePicture" alt="Profile" class="rounded-circle" width="40" height="40" />

										<div class="ms-2">
											<strong>@item.UserName</strong>
											@* <div class="text-muted">@(user != null ? user.Departments.Name : "No Department")</div> *@
										</div>
									</div>
								</td>
								<td>@item.LeaveType</td>
								<td>@item.StartDate.ToString("yyyy-MM-dd")</td>
								<td>@item.EndDate.ToString("yyyy-MM-dd")</td>
								<td>@item.NumberOfDays</td>
								<td>@item.Reason</td>
								<td>@item.ApprovedBy</td>
								<td>
									@if (item.Status == "Approved")
									{
										<span class="badge bg-success">✅ Approved</span>
									}
									else if (item.Status == "Pending")
									{
										<span class="badge bg-warning text-dark">⏳ Pending</span>
									}
									else if (item.Status == "Rejected")
									{
										<span class="badge bg-danger">❌ Rejected</span>
									}
									else
									{
										<span class="badge bg-secondary">Unknown</span>
									}
								</td>
								<td>@item.StatusHistory</td>
							</tr>
						}
					</tbody>
					<tfoot>
						<tr>
							<td colspan="10">
								<nav>
									<ul class="pagination justify-content-end mb-0" id="pagination">
										<!-- Pagination links will be inserted here -->
									</ul>
								</nav>
							</td>
						</tr>
					</tfoot>
				</table>
			</div>
		</div>
	</div>


	<div class="footer d-sm-flex align-items-center justify-content-between border-top bg-white p-3">
		<p class="mb-0">2014 - 2025 &copy; SmartHR.</p>
		<p>Designed &amp; Developed By <a href="javascript:void(0);" class="text-primary">Dreams</a></p>
	</div>
	<!-- jQuery -->
	<script src="assets/js/jquery-3.7.1.min.js"></script>

	<!-- Bootstrap Core JS -->
	<script src="assets/js/bootstrap.bundle.min.js"></script>

	<!-- Feather Icon JS -->
	<script src="assets/js/feather.min.js"></script>

	<!-- Slimscroll JS -->
	<script src="assets/js/jquery.slimscroll.min.js"></script>

	<!-- Color Picker JS -->
	@* <script src="assets/plugins/@simonwep/pickr/pickr.es5.min.js"></script> *@

	<!-- Datatable JS -->
	<script src="assets/js/jquery.dataTables.min.js"></script>
	<script src="assets/js/dataTables.bootstrap5.min.js"></script>

	<!-- Daterangepikcer JS -->
	<script src="assets/js/moment.js"></script>
	<script src="assets/plugins/daterangepicker/daterangepicker.js"></script>
	<script src="assets/js/bootstrap-datetimepicker.min.js"></script>

	<!-- Select2 JS -->
	<script src="assets/plugins/select2/js/select2.min.js"></script>

	<!-- Bootstrap Tagsinput JS -->
	<script src="assets/plugins/bootstrap-tagsinput/bootstrap-tagsinput.js"></script>

	<!-- Chart JS -->
	<script src="assets/plugins/apexchart/apexcharts.min.js"></script>
	<script src="assets/plugins/apexchart/chart-data.js"></script>

	<!-- Custom JS -->
	<script src="assets/js/theme-colorpicker.js"></script>
	<script src="assets/js/script.js"></script>

	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
	<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">

	<script>
		document.addEventListener("DOMContentLoaded", function () {
			var leaveData = @Html.Raw(ViewBag.JsonData); // Fetch data from ViewBag

			// Extract unique years (X-axis labels)
			var years = [...new Set(leaveData.map(d => d.Year))];

			// Extract unique leave types (for stacking)
			var leaveTypes = [...new Set(leaveData.map(d => d.LeaveType))];

			// Prepare datasets dynamically
			var datasets = leaveTypes.map(type => ({
				label: type,
				backgroundColor: getBackgroundColor(type),
				stack: 'Leave',
				data: years.map(year => {
					let leaveEntry = leaveData.find(d => d.Year === year && d.LeaveType === type);
					return leaveEntry ? leaveEntry.LeaveCount : 0;
				})
			}));

			// Function to assign colors dynamically
			function getBackgroundColor(type) {
				const colors = {
					"Sick Leave": 'green',
					"Paid Leave": 'blue',
					"Casual Leave": 'gold',
					"Maternity": 'black'
				};
				return colors[type] || 'gray'; // Default color
			}

			// Create the stacked bar chart
			var ctx = document.getElementById('leaveChart').getContext('2d');
			new Chart(ctx, {
				type: 'bar',
				data: {
					labels: years, // X-axis (Years)
					datasets: datasets // Stacked datasets
				},
				options: {
					responsive: true,
					maintainAspectRatio: false,
					plugins: {
						legend: { position: 'top' }
					},
					scales: {
						x: { stacked: true },
						y: { stacked: true, ticks: { stepSize: 5 } }
					}
				}
			});
		});
	</script>

	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script>
		$(document).ready(function () {
			function fetchAllData() {
				$.ajax({
					url: '@Url.Action("GetAllReports", "LeaveReport")', // Fetch all data from the server
					type: "GET",
					success: function (response) {
						populateTable(response); // Populate the table with all data initially
					},
					error: function (xhr, status, error) {
						console.log("Error:", error);
					}
				});
			}

			function fetchFilteredReports() {
				var dateFilter = $("#dateFilter").val();
				var statusFilter = $("#statusFilter").val();
				var sortOrder = $("#sortOrder").val();

				$.ajax({
					url: '@Url.Action("GetFilteredReports", "LeaveReport")',
					type: "GET",
					data: {
						dateFilter: dateFilter,
						statusFilter: statusFilter,
						sortOrder: sortOrder
					},
					success: function (response) {
						populateTable(response);
					},
					error: function (xhr, status, error) {
						console.log("Error:", error);
					}
				});
			}

			function populateTable(data) {
				var tableBody = $("#LeaveTable tbody");
				tableBody.empty(); // Clear previous records

				if (data.length === 0) {
					tableBody.append(`<tr><td colspan="10" class="text-center">No records found</td></tr>`);
					return;
				}

						$.each(data, function (index, item) {
			var statusBadge = "";
			if (item.status === "Approved") {
				statusBadge = `<span class="badge bg-success">✅ Approved</span>`;
			} else if (item.status === "Pending") {
				statusBadge = `<span class="badge bg-warning text-dark">⏳ Pending</span>`;
			} else if (item.status === "Rejected") {
				statusBadge = `<span class="badge bg-danger">❌ Rejected</span>`;
			} else {
				statusBadge = `<span class="badge bg-secondary">Unknown</span>`;
			}

			var row = `<tr>
				<td>${item.leaveRequestId}</td>
				<td>
					<div class="d-flex align-items-center">
					<img src="/${item.profilePicture}" alt="Profile" class="rounded-circle" width="40" height="40"/>
						<div class="ms-2">
							<strong>${item.userName}</strong>
						</div>
					</div>
				</td>
				<td>${item.leaveType}</td>
				<td>${formatDate(item.startDate)}</td>
				<td>${formatDate(item.endDate)}</td>
				<td>${item.numberOfDays}</td>
				<td>${item.reason}</td>
				<td>${item.approvedBy || 'N/A'}</td>
				<td>${statusBadge}</td>
				<td>${item.statusHistory}</td>
			</tr>`;

			$("#Leave").append(row);
		});

		// Function to format date (YYYY-MM-DD)
		function formatDate(dateString) {
			if (!dateString) return "";
			var date = new Date(dateString);
			return date.toISOString().split('T')[0]; // Extract YYYY-MM-DD
		}

			}

			// Load all data initially
			fetchAllData();

			// Event listeners for filter changes
			$("#dateFilter, #statusFilter, #sortOrder").change(fetchFilteredReports);
		});
	</script>

	@section Scripts {
		<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">

		<!-- jQuery -->
		<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

		<!-- DataTables JS -->
		<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
		<script>
			$(document).ready(function() {
				// Initialize DataTables
				$('#LeaveTable').DataTable({
					"paging": true,    // Enable pagination
					"searching": true, // Enable search functionality
					"ordering": true,  // Enable sorting
					"info": true,      // Display information
					"pageLength": 10,   // Default number of rows per page
				});
			});
		</script>
	}



</body>

</html>

