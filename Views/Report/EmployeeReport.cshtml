@{
    ViewData["Title"] = "Employee Report";
    var totalUsers = ViewBag.TotalUsers;
    var activeUsers = ViewBag.ActiveUsers;
    var departmentsCount = ViewBag.DepartmentsCount;
    var rolesCount = ViewBag.RolesCount;
    var chartLabels = ViewBag.ChartLabels as int[] ?? new int[] { };
    var chartData = ViewBag.ChartData as int[] ?? new int[] { };
}

<div class="d-flex justify-content-end mb-3">
    <div class="dropdown">
        <button class="btn btn-danger" type="button" id="exportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            Export
        </button>
        <ul class="dropdown-menu" aria-labelledby="exportDropdown">
            <li>
                <a class="dropdown-item" href="@Url.Action("ExportToCSV", "Report")" id="export_csv">
                    Export to CSV
                </a>
            </li>
            <li>
                <a class="dropdown-item" href="@Url.Action("ExportToPDF", "Report")" id="export_pdf">
                    Export to PDF
                </a>
            </li>
        </ul>
    </div>
</div>

<div style="display: flex;">
    <div style="width: 50%;">
        <!-- Cards -->
        <div style="display: flex; flex-wrap: wrap;">
            <div style="width: 50%; padding: 10px;">
                <div style="background-color: #f8f9fa; padding: 20px; border-radius: 5px; text-align: center;">
                    <h3><i class="bi bi-person-circle text-danger me-2"></i> Total Users</h3>
                    <p>@totalUsers</p>
                </div>
            </div>
            <div style="width: 50%; padding: 10px;">
                <div style="background-color: #f8f9fa; padding: 20px; border-radius: 5px; text-align: center;">
                    <h3><i class="bi bi-person-check text-danger me-2"></i> Active Users</h3>
                    <p>@activeUsers</p>
                </div>
            </div>
            <div style="width: 50%; padding: 10px;">
                <div style="background-color: #f8f9fa; padding: 20px; border-radius: 5px; text-align: center;">
                    <h3><i class="bi bi-person-x text-danger me-2"></i> Inactive Users</h3>
                    <p>@ViewBag.InactiveUsers</p>
                </div>
            </div>
            <div style="width: 50%; padding: 10px;">
                <div style="background-color: #f8f9fa; padding: 20px; border-radius: 5px; text-align: center;">
                    <h3><i class="bi bi-briefcase text-danger me-2"></i> Roles</h3>
                    <p>@rolesCount</p>
                </div>
            </div>
        </div>
    </div>

    <div style="position: relative; width: 50%;">
        <!-- Label and Icon -->
        <div class="position-absolute top-0 start-0 p-2" style="z-index: 100;">
            <h5 class="d-inline-flex align-items-center mb-0">
                <i class="bi bi-bar-chart-fill text-danger me-2"></i> Employee
            </h5>
            <br />
            <br />
        </div>
        <!-- Bar Graph -->
        <canvas id="barChart"></canvas>
    </div>
</div>

<div style="width: 100%; margin-right: 0px;">
    <div class="table-responsive">
        <!-- Filters and Search Bar (Right Side) -->
        <div class="col-md-10">
            <div class="row mb-3">
                <!-- Filter by Status -->
                <div class="col-md-4">
                    <select id="statusFilter" class="form-select">
                        <option value="">All Status</option>
                        <option value="Active">Active</option>
                        <option value="Inactive">Deactive</option>
                    </select>
                </div>
                <!-- Filter by Department -->
                <div class="col-md-4">
                    <select id="departmentFilter" class="form-select">
                        <option value="">All Departments</option>
                        @foreach (var dept in ViewBag.Departments)
                        {
                            <option value="@dept.DepartmentId">@dept.Name</option>
                        }
                    </select>
                </div>
                <!-- Search Bar -->
                <div class="col-md-4">
                    <input type="text" id="searchBar" class="form-control" placeholder="Search by name or email">
                </div>
            </div>

            <!-- Employee Table -->
            <table id="employeeTable" class="table table-striped table-bordered table-hover align-middle" style="table-layout: fixed;">
                <thead class="table-dark">
                    <tr>
                        <th>UserId</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Department</th>
                        <th>Phone Number</th>
                        <th>Date of Joining</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="employeeTableBody">
                    <!-- Data will be dynamically loaded via AJAX -->
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="7">
                            <ul class="pagination justify-content-right mb-0" id="pagination">
                                <!-- Pagination links will be inserted here -->
                            </ul>
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>



    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <script>
        const ctx = document.getElementById('barChart').getContext('2d');
        const barChart = new Chart
            (ctx, {
                type: 'bar',
                data:
                {
                    labels: @Html.Raw(Json.Serialize(ViewBag.ChartLabels)),
                    datasets:
                        [
                            {
                                label: 'Active Users',
                                data: @Html.Raw(Json.Serialize(ViewBag.ActiveData)),
                                backgroundColor: 'rgba(75, 192, 75, 0.6)', // Green
                                borderColor: 'rgba(75, 192, 75, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Inactive Users',
                                data: @Html.Raw(Json.Serialize(ViewBag.InactiveData)),
                                backgroundColor: 'rgba(128, 128, 128, 0.6)', // Grey
                                borderColor: 'rgba(128, 128, 128, 1)',
                                borderWidth: 1
                            }
                        ]
                },
                options:
                {
                    responsive: true,
                    plugins:
                    {
                        legend:
                        {
                            position: 'top'
                        }
                    },
                    scales:
                    {
                        x:
                        {
                            stacked: false
                        },
                        y:
                        {
                            beginAtZero: true,
                            ticks:
                            {
                                stepSize: 10
                            }
                        }
                    }
                }
            });


        $(document).ready(function () {
            // Load employees when the page loads with default values
            loadEmployees(); // Initial load with default values

            // Pagination
            $(document).on('click', '.page-link', function (e) {
                e.preventDefault();
                const page = $(this).data('page');
                const status = $('#statusFilter').val();
                const department = $('#departmentFilter').val();
                const search = $('#searchBar').val();
                loadEmployees(page, status, department, search);
            });

            // Filters: status, department, and search bar
            $('#statusFilter, #departmentFilter, #searchBar').on('change input', function () {
                const status = $('#statusFilter').val();
                const department = $('#departmentFilter').val();
                const search = $('#searchBar').val();
                loadEmployees(1, status, department, search);
            });
        });

        const loadEmployees = (page = 1, status = '', department = '', search = '') => {
            $.ajax({
                url: '/Ajax/GetEmployees', // Ensure this matches the route
                method: 'GET',
                data: {
                    page,
                    status,
                    department,
                    search,
                },
                success: function (response) {
                    // Populate the table body
                    $('#employeeTableBody').html('');
                    response.data.forEach((employee) => {
                        $('#employeeTableBody').append(`
                                    <tr>
                                        <td>${employee.userId}</td>
                                        <td>${employee.name}</td>
                                        <td>${employee.email}</td>
                                        <td>${employee.departmentName}</td>
                                        <td>${employee.phoneNumber}</td>
                                        <td>${employee.dateOfJoining}</td>
                                        <td>${employee.status}</td>
                                    </tr>
                                `);
                    });

                    // Populate pagination
                    $('#pagination').html('');
                    for (let i = 1; i <= response.totalPages; i++) {
                        $('#pagination').append(`
                                    <li class="page-item ${i === page ? 'active' : ''}">
                                        <a class="page-link" href="#" data-page="${i}">${i}</a>
                                    </li>
                                `);
                    }
                },
                error: function (error) {
                    console.error('Error loading employees:', error);
                },
            });
        };

    </script>

